# Tacotron-2 - 제2부 데이터 전 처리

## I. 텍스트 처리

음성 분석하기 전에는 텍스트를 먼저 음소로 분리할 필요가 있습니다 (graphemes to phonemes). 

여러 처리 방법 있는데, 저희가 https://github.com/scarletcho/KoG2P 방법을 적용합니다. 
이 방법은, 먼저 한글에 있는 음소를 모두 아래 데이플에 정의합니다:

    hangul_symbol_1 = [u"␀", u"␃", u'"', " ", "!", ",", ".", "?", 'aa', 'c0', 'cc', 'ch', 'ee', 'h0', 'ii', 'k0', 'kf', 'kh',
                       'kk',
                       'ks', 'lb', 'lh', 'lk', 'll', 'lm', 'lp',
                       'ls', 'lt', 'mf', 'mm', 'nc', 'nf', 'nh', 'nn', 'ng', 'oh', 'oo', 'p0', 'pf', 'ph', 'pp', 'ps', 'qq',
                       'rr',
                       's0',
                       'ss', 't0', 'tf', 'th', 'tt', 'uu', 'vv', 'wa', 'we', 'wi', 'wo', 'wq', 'wv', 'xi', 'xx', 'ya', 'ye',
                       'yo',
                       'yq', 'yu', 'yv']
                   

그다음에 텍스트에 있는 수자가 모두 텍스트로 바꾸고 위 음소 규직적용하고 분리합니다. 마지막 symbol는 특변한 "끝" symbol 입니다. 
예를 들어 "올해 유월은 유난히 쌀쌀해요" 문장은: 

    ['oo', 'll', 'h0', 'qq', ' ', 'yu', 'wv', 'rr', 'xx', 'nf', ' ', 'nn', 'yu', 'nn', 'aa', 'nf', 'h0', 'ii', ' ', 'ss', 'aa', 'll', 'ss', 'aa', 'll', 'h0', 'qq', 'yo', '␃']

음소로 바꿔 됩니다. 

이 음소가 음소 데이플에 matching하고 ID (데이플에 음소의 위치) sequence 리스트 됩니다. 

    [36,  23,  13,  42,  3,  64,  57,  43,  59,  31,  3,  33,  64,  33,  8,  31,  13,  14,  3,  45,  8,  23,  45,  8,  23,  13,  42,  62,  1]


## II. 음성 처리

음성 파일은 librosa package (librosa.load()) 사용하여 series으로 변환됩니다. 

우리 예 문장의 음성은 wav.shape = (65792,) 1-d array로 변환되었고 아래 예시 100 데이터 점입니다.  (위치 10000~10100)

    wav[10000:10100] = array([-2.3133825e-03, -1.3194837e-03,  8.8331959e-04,  1.7781456e-03,
            8.1384653e-04,  1.4920419e-04,  3.4220162e-04, -4.8555573e-04,
           -1.5456340e-03, -6.0020003e-04,  7.8924972e-04,  6.3178834e-04,
            2.8037373e-04,  2.4422831e-04, -6.1932980e-04, -1.1501492e-03,
            3.2804158e-04,  2.3582182e-03,  2.2964689e-03, -9.8070406e-05,
           -2.2866633e-03, -2.3068197e-03, -1.3926239e-03, -7.4133358e-04,
            8.7850477e-04,  2.8203547e-03,  1.9981163e-03, -9.2029147e-04,
           -1.6866650e-03,  6.9744291e-04,  2.7199618e-03,  1.4540078e-03,
           -1.7359130e-03, -3.1208040e-03, -1.6292079e-03,  6.1948912e-04,
            2.1509442e-03,  2.5075129e-03,  1.0285970e-03, -1.1447296e-03,
           -1.6268947e-03, -7.6268188e-04, -6.9026998e-04, -1.2097602e-03,
           -4.9221399e-04,  1.2999423e-03,  1.9035385e-03,  3.9858453e-04,
           -1.1544389e-03, -8.1619254e-04,  3.6142115e-04,  5.2562490e-04,
           -5.8381269e-05, -4.8793903e-05,  8.3098479e-04,  1.6094970e-03,
            1.1537386e-03, -4.3267451e-04, -1.5666294e-03, -1.2281921e-03,
           -4.3874918e-04, -3.0550809e-04, -1.1458800e-04,  8.1160117e-04,
            1.4543658e-03,  9.7073906e-04, -2.5107287e-05, -6.2474358e-04,
           -3.5203181e-04,  4.5432683e-04,  6.9041608e-04,  1.7013005e-04,
           -3.4710133e-04, -8.9110120e-04, -1.2556601e-03, -3.3588154e-04,
            1.2241756e-03,  1.3975429e-03,  1.7853483e-04, -6.4078049e-04,
            1.9035768e-04,  2.0036905e-03,  1.9612515e-03, -1.3168824e-03,
           -4.4885073e-03, -4.1275411e-03, -1.5732610e-03,  5.8217440e-04,
            2.1232467e-03,  3.0864687e-03,  2.4667743e-03,  3.1637246e-04,
           -1.5402654e-03, -1.7881830e-03, -1.0609415e-03, -2.3099426e-04,
            6.0060632e-04,  8.0085872e-04,  1.5415817e-04,  3.8333607e-04],
          dtype=float32)
      
1-d 데이터로 분석 가능하지만 tacotron-2에는 1-d 아니고 melspectrogram를 분석하면 성능이 좋다고 인증되었습니다. 

Librosa package 사용하여 위 array을 아래 melspectrogram으로 변환 됩니다. 

![melspectrogram](https://github.com/tdplaza/tdplaza.github.io/blob/master/images/mel.PNG)

가로는 음성 파일의 길이이고 세로는 melspectrogram 채널 입니다. 색갈은 데이터 점의 크기의 따라 다릅니다. 


여기까지는 우리 2 input 변수: 1-d 텍스트 array과 2-d melspectrogram array가 있습니다.
